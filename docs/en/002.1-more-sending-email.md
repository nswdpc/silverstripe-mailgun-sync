# Sending email (more detailed)

MailgunEmail has support for custom parameters and tags. Custom parameters are useful for manaing email send on a per-email basis. Tags are useful for analytics/reporting.

> Note: [Mailgun places a limit of 3 tags per message](https://documentation.mailgun.com/en/latest/user_manual.html#tagging)

Here is an example of setting some custom options:
```php
<?php
namespace My\App;

use SilverStripe\Control\Email\Email;

// Custom class in your app
$person = get_person();

// Set parameters (no need to prefix keys)
$parameters = [

    // Set v: prefixed variables
    'variables' => [
        'test' => 'true',
        'foo' => 'bar',
    ],

    // Set o: prefixed options
    'options' => [
        'deliverytime' => $person->getReminderTime(\DateTimeInterface::RFC2822),
        'dkim' => 'yes',// require DKIM for this specific message
        'tag' => ['tag1','tag2','tag4'], // send some tags for analytics
        'tracking' => 'yes', // turn tracking on just for this message
        'require-tls' => 'yes', // require a TLS connection when Mailgun connects to the remote mail server
        'skip-verification' => 'no' // do not skip TLS verification
    ],

    // h: prefixed headers
    'headers' => [
        'X-Test-Header' => 'testing'
    ],

    // Specific recipient variables
    'recipient_variables' => [
        $person->Email => ["tagline" => "Reminder"]
    ]
];

// Send the email
// Email will be an instance of MailgunEmail, if configuration is in place
$email = Email::create();
$email->setTo($person->Email)
    ->setSubject('A reminder')
    ->setFrom('someone.else@example.com')
    // apply custom parameters to this particular email
    ->setCustomParameters($parameters)
    ->send();
```

## Tagging

`MailgunEmail` uses our [`Taggable` trait](https://github.com/nswdpc/silverstripe-taggable-notifications) to set tags on a message.

```php
<?php
namespace My\App;

use SilverStripe\Control\Email\Email;

$email = Email::create();
$response = $email->setTo('someone@example.com')
    ->setSubject('Tagged message')
    ->setFrom('someone.else@example.com')
    // tag this email with 3 tags tag1, tag2 and tag4 - tag values are up to you
    ->setNotificationTags(['tag1','tag2','tag4']);
    ->send();
```

Internally, this adds the tags to the options.tag parameter provided to the Mailgun API.

> Tags set via this method or setCustomParameters will override other methods of tagging.

## Future delivery

> Queued sending in Silverstripe can also help with sending emails in the future.

To send in the future, use [scheduled delivery](https://documentation.mailgun.com/en/latest/user_manual.html#scheduling-delivery) with an RFC2822 formatted datetime.

```php
<?php
// Send an email in 2032!
$options = [
    'deliverytime' => 'Fri, 14 Oct 2032 06:30:00 +1100'
];
```
